name: Update README Widget

on:
  schedule:
    - cron: '0 * * * *'  # Hourly
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Fetch API data and update README
        run: |
          set -e
          json=$(curl -s "https://nomads.com/@danielreilly.json?key=b9ec566fe67015f63c7d6225ff9e5a4d")

          currentCity=$(echo "$json" | jq -r '.location.now.city')
          currentCountry=$(echo "$json" | jq -r '.location.now.country')

          nextCity=$(echo "$json" | jq -r '.location.next[0].city')
          nextCountry=$(echo "$json" | jq -r '.location.next[0].country')
          nextStart=$(echo "$json" | jq -r '.location.next[0].start_date')
          nextEnd=$(echo "$json" | jq -r '.location.next[0].end_date')

          lastCity=$(echo "$json" | jq -r '.location.previous[0].city')
          lastCountry=$(echo "$json" | jq -r '.location.previous[0].country')
          lastStart=$(echo "$json" | jq -r '.location.previous[0].start_date')
          lastEnd=$(echo "$json" | jq -r '.location.previous[0].end_date')

          countries=$(echo "$json" | jq -r '.stats.countries')
          cities=$(echo "$json" | jq -r '.stats.cities')
          km=$(echo "$json" | jq -r '.stats.distance_traveled_km')
          mi=$(echo "$json" | jq -r '.stats.distance_traveled_miles')
          mostCity=$(echo "$json" | jq -r '.stats.most_visited.city')
          mostCount=$(echo "$json" | jq -r '.stats.most_visited.count')
          longestCity=$(echo "$json" | jq -r '.stats.longest_stay.city')
          longestDays=$(echo "$json" | jq -r '.stats.longest_stay.days')

          mapLink="https://url2og.com/?url=https%3A%2F%2Fnomads.com%2F%40danielreilly%3Fmap_only%3Dtrue%26key%3Db9ec566fe67015f63c7d6225ff9e5a4d"

          cat <<EOF > widget.md
### üåç Where am I?

**üìç Currently in:** $currentCity, $currentCountry  
**üõ´ Next:** $nextCity, $nextCountry ‚Äî *$nextStart‚Äì$nextEnd*  
**üõ¨ Last:** $lastCity, $lastCountry ‚Äî *$lastStart‚Äì$lastEnd*

---

**üß≠ Stats**  
- **Countries visited:** $countries  
- **Cities visited:** $cities  
- **Distance traveled:** $km km / $mi mi  
- **Most visited city:** $mostCity ($mostCount trips)  
- **Longest stay:** $longestCity ‚Äî $longestDays days

---

**üó∫ Map:** [View Nomads Travel Map]($mapLink)
EOF

          awk '/<!-- WIDGET_START -->/ { print; system("cat widget.md"); in=1; next }
               /<!-- WIDGET_END -->/ { print; in=0; next }
               !in { print }' README.md > temp.md

          mv temp.md README.md

      - name: Commit changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --quiet; then
            echo "No changes"
          else
            git commit -m "Update dynamic widget"
            git push
          fi
