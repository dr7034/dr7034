name: Update README Widget

on:
  schedule:
    - cron: '0 * * * *'  # Runs hourly; adjust as needed
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Fetch API data and create widget
        run: |
          set -e
          json=$(curl -s "https://nomads.com/@danielreilly.json?key=b9ec566fe67015f63c7d6225ff9e5a4d")

          currentCity=$(echo "$json" | jq -r '.location.now.city // "Unknown City"')
          currentCountry=$(echo "$json" | jq -r '.location.now.country // "Unknown Country"')

          nextCity=$(echo "$json" | jq -r '
            (.location.next // []) 
            | (if type == "object" then [.] else . end)
            | if length > 0 then .[0].city else "No upcoming location" end
          ')
          nextCountry=$(echo "$json" | jq -r '
            (.location.next // []) 
            | (if type == "object" then [.] else . end)
            | if length > 0 then .[0].country else "" end
          ')
          nextStart=$(echo "$json" | jq -r '
            (.location.next // []) 
            | (if type == "object" then [.] else . end)
            | if length > 0 then .[0].date_start else "" end
          ')
          nextEnd=$(echo "$json" | jq -r '
            (.location.next // []) 
            | (if type == "object" then [.] else . end)
            | if length > 0 then .[0].date_end else "" end
          ')

          lastCity=$(echo "$json" | jq -r '
            (.location.previous // []) 
            | (if type == "object" then [.] else . end)
            | if length > 0 then .[0].city else "Unknown" end
          ')
          lastCountry=$(echo "$json" | jq -r '
            (.location.previous // []) 
            | (if type == "object" then [.] else . end)
            | if length > 0 then .[0].country else "" end
          ')
          lastStart=$(echo "$json" | jq -r '
            (.location.previous // []) 
            | (if type == "object" then [.] else . end)
            | if length > 0 then .[0].date_start else "" end
          ')
          lastEnd=$(echo "$json" | jq -r '
            (.location.previous // []) 
            | (if type == "object" then [.] else . end)
            | if length > 0 then .[0].date_end else "" end
          ')

          countries=$(echo "$json" | jq -r '.stats.countries // 0')
          cities=$(echo "$json" | jq -r '.stats.cities // 0')
          distanceKm=$(echo "$json" | jq -r '.stats.distance_traveled_km // 0')
          distanceMi=$(echo "$json" | jq -r '.stats.distance_traveled_miles // 0')

          mostCity=$(echo "$json" | jq -r '
            .frequent_visits 
            | to_entries 
            | sort_by(-.value) 
            | if length > 1 then .[1].key else "Unknown" end
            | gsub("-"; " ") 
            | split(" ") 
            | map(.[0:1] | ascii_upcase + .[1:]) 
            | join(" ")
          ')
          mostCount=$(echo "$json" | jq -r '
            .frequent_visits 
            | to_entries 
            | sort_by_
