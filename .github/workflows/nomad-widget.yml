name: Update README Widget

on:
  schedule:
    - cron: '0 * * * *'  # Runs hourly
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Fetch API data and create widget
        run: |
          set -e

          json=$(curl -s "https://nomads.com/@danielreilly.json?key=b9ec566fe67015f63c7d6225ff9e5a4d")

          currentCity=$(echo "$json" | jq -r '.location.now.city // "Unknown City"')
          currentCountry=$(echo "$json" | jq -r '.location.now.country // "Unknown Country"')

          nextCity=$(echo "$json" | jq -r '.location.next[0].city // "None"')
          nextCountry=$(echo "$json" | jq -r '.location.next[0].country // ""')
          nextStart=$(echo "$json" | jq -r '.location.next[0].date_start // ""')
          nextEnd=$(echo "$json" | jq -r '.location.next[0].date_end // ""')

          lastCity=$(echo "$json" | jq -r '.location.last[0].city // "None"')
          lastCountry=$(echo "$json" | jq -r '.location.last[0].country // ""')
          lastStart=$(echo "$json" | jq -r '.location.last[0].date_start // ""')
          lastEnd=$(echo "$json" | jq -r '.location.last[0].date_end // ""')

          cities=$(echo "$json" | jq -r '.stats.cities // 0')
          countries=$(echo "$json" | jq -r '.stats.countries // 0')
          distanceKm=$(echo "$json" | jq -r '.stats.distance_traveled_km // 0')
          distanceMiles=$(echo "$json" | jq -r '.stats.distance_traveled_miles // 0')

          mostCity=$(echo "$json" | jq -r '
            .frequent_visits
            | to_entries | sort_by(-.value)
            | if length > 1 then .[1] else empty end
            | "\(.key) |\(.value)"
          ')
          mostCityName=$(echo "$mostCity" | cut -d'|' -f1 | tr '-' ' ' | sed 's/\b\(.\)/\u\1/g')
          mostCityTrips=$(echo "$mostCity" | cut -d'|' -f2 | xargs)

          longestCity=$(echo "$json" | jq -r '
            .longest_stays
            | to_entries | sort_by(-.value)
            | if length > 1 then .[1] else empty end
            | "\(.key) |\(.value)"
          ')
          longestCityName=$(echo "$longestCity" | cut -d'|' -f1 | tr '-' ' ' | sed 's/\b\(.\)/\u\1/g')
          longestCityDays=$(echo "$longestCity" | cut -d'|' -f2 | xargs)

          echo "#### ðŸŒ Where am I?" > widget.md
          echo "" >> widget.md
          echo "**ðŸ“ Currently in:** $currentCity, $currentCountry" >> widget.md
          echo "**ðŸ›« Next:** $nextCity, $nextCountry â€” *${nextStart}â€“${nextEnd}*" >> widget.md
          echo "**ðŸ›¬ Last:** $lastCity, $lastCountry â€” *${lastStart}â€“${lastEnd}*" >> widget.md
          echo "" >> widget.md
          echo "**ðŸ§­ Stats**" >> widget.md
          echo "- **Countries visited:** $countries" >> widget.md
          echo "- **Cities visited:** $cities" >> widget.md
          echo "- **Distance traveled:** ${distanceKm} km / ${distanceMiles} mi" >> widget.md
          echo "- **Most visited city:** $mostCityName ($mostCityTrips trips)" >> widget.md
          echo "- **Longest stay:** $longestCityName â€” $longestCityDays days" >> widget.md
          echo "" >> widget.md
          echo "**ðŸ—º Map:** [View Nomads Travel Map](https://url2og.com/?url=https%3A%2F%2Fnomads.com%2F%40danielreilly%3Fmap_only%3Dtrue%26key%3Db9ec566fe67015f63c7d6225ff9e5a4d)" >> widget.md

          awk '/<!-- WIDGET_START -->/ { print; system("cat widget.md"); in_widget=1; next } /<!-- WIDGET_END -->/ { print; in_widget=0; next } !in_widget { print }' README.md > temp.md
          mv temp.md README.md

      - name: Commit changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff-index --quiet HEAD; then
            echo "No changes to commit"
          else
            git commit -m "Update dynamic widget"
            git push origin HEAD:${{ github.ref }}
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
